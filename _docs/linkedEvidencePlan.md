####1 Overview
This feature provides clinicians with a "Click-to-Highlight" user flow to instantly verify the AI-generated summary against the original transcript. By clicking on a block of text in the summary, the corresponding conversational turns in the transcript that were used as its source will be highlighted. This builds trust and transparency into the AI workflow.
The implementation uses a two-step AI process: the first call generates the summary, and a second, specialized call generates a "linking map" between the summary and the transcript. This separation of concerns ensures higher reliability and easier maintenance.


####2 Key Steps
1.  **Database Schema Update**: Add a new `linking_map_json` column to the `form_ai_summary` table to store the structured linking data generated by the AI.
2.  **Create a Text Splitting Utility**: Develop a centralized PHP utility class (`TextUtil`) to consistently split the transcript into conversation turns and the summary into logical blocks. This ensures both the backend AI process and the frontend display use the exact same logic.
3.  **Backend Orchestration**: Modify the existing `generate_summary.php` script to perform a two-step AI process:
    *   Call #1: Generate the summary using `AISummaryPrompt.md`.
    *   Call #2: Use a new `linkedEvidenceprompt.md` to generate the JSON linking map from the transcript and the newly created summary.
    *   Validate the AI's returned map and save both the summary and the map to the database.
4.  **Frontend Rendering & Interaction**: Update the `report.php` file for the AI Summary form:
    *   Render the summary and transcript side-by-side, wrapping each block/turn in a `<span>` or `<p>` with a unique, predictable ID.
    *   Implement JavaScript to handle the "Click-to-Highlight" flow, using the linking map to connect summary blocks to transcript turns.


####3 Data Flow
1.  **User Action**: Clinician clicks the "Generate Summary & Links" button in the AI Summary form within an encounter.
2.  **AJAX Request**: An AJAX call is sent to `interface/forms/ai_summary/generate_summary.php` with the `form_id`.
3.  **Backend Processing (`generate_summary.php`):**
    *   Fetches the raw transcript (`DrVisit.md` content) from the `form_ai_summary` table.
    *   **AI Call #1:** Sends the transcript to the OpenAI API with `AISummaryPrompt.md`.
    *   Receives the plain-text summary back.
    *   **Text Splitting:** Uses `TextUtil::splitByConversationTurns()` on the transcript and `TextUtil::splitSummaryIntoBlocks()` on the new summary.
    *   **AI Call #2:** Sends the split transcript turns and summary blocks (formatted as JSON) to the OpenAI API with the new `linkedEvidenceprompt.md`.
    *   Receives a JSON `linking_map` back.
    *   **Validation:** The backend validates that all indices in the `linking_map` are within the bounds of the actual turn/block counts.
    *   **Database Update:** Saves the `ai_summary` text and the validated `linking_map_json` to the `form_ai_summary` table for that `form_id`.
4.  **AJAX Response**: The backend returns a JSON object to the browser containing the final summary text and the linking map.
5.  **Frontend Interaction (`report.php`):**
    *   The page reloads or the content is dynamically updated.
    *   The summary and transcript are rendered with unique IDs on each block/turn.
    *   The JavaScript uses the received `linking_map` to power the click-to-highlight functionality.

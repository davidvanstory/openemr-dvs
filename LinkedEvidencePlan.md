# Linked Evidence Feature Plan

### 1. Overview

This feature provides clinicians with a "Click-to-Highlight" user flow to instantly verify the AI-generated summary against the original transcript. By clicking on a block of text in the summary, the corresponding conversational turns in the transcript that were used as its source will be highlighted. This builds trust and transparency into the AI workflow.

The implementation uses a two-step AI process triggered by two separate buttons, ensuring a clear separation of concerns for higher reliability and easier maintenance.

### 2. Key Steps

1.  **Database Schema Update**: Add a new `linking_map_json` column to the `form_ai_summary` table to store the structured linking data generated by the AI.
2.  **Create a Text Splitting Utility**: Develop a centralized PHP utility class (`TextUtil`) to consistently split the transcript into conversation turns and the summary into logical blocks. This ensures both the backend AI process and the frontend display use the exact same logic.
3.  **Backend Orchestration**: Create a new `link_evidence.php` script to perform the linking task, leaving `generate_summary.php` untouched. This new script will:
    *   Fetch the existing summary and transcript.
    *   Use a new `LinkedEvidencePrompt.md` to generate the JSON linking map.
    *   Validate the AI's returned map and save it to the database.
4.  **Frontend Rendering & Interaction**: Update the `report.php` file for the AI Summary form to manage the two-step user flow:
    *   Initially, show only the "Generate Summary" button.
    *   After a summary is generated, show a new "Link Evidence" button.
    *   After linking is complete, enable the interactive click-to-highlight view.
    *   Render the summary and transcript side-by-side, wrapping each block/turn in a `<p>` tag with a unique, predictable ID.

### 3. Data Flow

1.  **User Action 1**: Clinician clicks the "Generate Summary" button. An AJAX call is sent to `interface/forms/ai_summary/generate_summary.php`. The summary is saved, and the page is refreshed.
2.  **Page Reload 1**: The page now detects a summary exists but a linking map does not. It displays the summary and a new "Link Evidence" button.
3.  **User Action 2**: Clinician clicks the "Link Evidence" button. An AJAX call is sent to the new `interface/forms/ai_summary/link_evidence.php`.
4.  **Backend Processing (`link_evidence.php`):**
    *   Fetches the raw transcript and the AI summary from the database.
    *   Uses `TextUtil` to split both into turns and blocks.
    *   Sends the split data to the OpenAI API with `LinkedEvidencePrompt.md`.
    *   Receives a JSON `linking_map` back, validates it, and saves it to the `linking_map_json` column.
5.  **AJAX Response & Page Reload 2**: The backend returns a success message. The frontend refreshes the page again.
6.  **Final State**: The page now detects both the summary and the linking map. It renders the full interactive view with click-to-highlight functionality enabled and hides the action buttons.